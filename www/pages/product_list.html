<template>
  <div class="page page-product_list" id="pageId_${pageId}" data-name="product_list">
    <div class="navbar ">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="left  no-margin-right">
          <a href="#" class="link icon-only back">
            <i class="icon f7-icons size-22">arrow_left</i>
          </a>
        </div>
        <div class="title">
          <h5 class="no-margin-bottom">${categoryName}</h5>
        </div>
        <div class="right text-align-center">
          <a href="/notificationlist/" class="link">
            <i class="icon f7-icons size-22">bell_fill</i>
          </a>
        </div>
      </div>
    </div>



    
    <div class="page-content has-footer">
      
      <!-- main page content -->
      <div class="main-container container">

        <!-- search -->
      
          
          <!-- <div class="searchbar-backdrop"></div>
            <form class="searchbar">
              <div class="searchbar-inner">
                <div class="searchbar-input-wrap">
                  <input type="search" placeholder="Search" />
                  <i class="searchbar-icon"></i>
                  <span class="input-clear-button"></span>
                </div>
                <span class="searchbar-disable-button">Cancel</span>
              </div>
            </form>
          </div> -->

                   <!-- Quick List -->
         <div class="block">
          <div class="row">
              <div class="col-100 ">
                  <div class="card elevation-2 margin-bottom-half">
                      <div class="mediaList customeList list searchbar-found">
                          <ul>
                             
                            ${product.map((item) => $h`

                              <li class="">
                                  <a class="item-link_" href="#">
                                      <div class="item-content">
                                          <div class="item-media padding-top-half padding-bottom-half">
                                              <img slot="media" src="${item.img}" width="30"
                                                  alt="" />
                                          </div>
                                          <div class="item-inner item-cell">
                                              <div class="item-row item-title_ font-12 bold text-color-theme">
                                                <a  href="/product/${item.id}/" >  
                                                  <div class="">${item.name}</div> 
                                                </a>
                                              </div>

                                              <!-- <div class="item-row item-footer">
                                                    <small class="font-11">${item.manufacturer}</small>
                                              </div> -->
                                              <div class="item-row item-footer">
                                                  <div class="col-auto item-footer">
                                                    <div class="item-row">
                                                      <small class="font-11">MRP</small>:<small class=" item-cell text-opac font-11" style="text-decoration: line-through;"> ₹ ${item.MRP}</small>
                                                    </div>
                                                    
                                                    <div class="item-row"> ₹ ${item.discount} </div>
                                                    
                                                  </div> 
                                                  <div class="col-auto item-footer font-10">
                                                        <span 
                                                        class="button button-small button-outline font-10 product_add_to_cart
                                                        ${item.isCartQnt > 0 && $h`
                                                          display-none
                                                          `} 
                                                        "
                                                        data-pid="${item.id}" 
                                                        data-quantity="1"
                                                        data-type="${type}"
                                                         >Add</span>

                                                           <!-- Stepper element -->
                                                        <!-- <div class="stepper">
                                                          <div class="stepper-button-minus counter-decrease"></div>
                                                          <div class="stepper-value counter-value">1</div>
                                                          <div class="stepper-button-plus counter-increase"></div>
                                                        </div> -->

                                                         <!-- button counter increamenter-->
                                                        <div class="counter-number

                                                          ${item.isCartQnt == 0 && $h`
                                                           display-none
                                                           `} 
                                                          ">
                                                          <button class="btn avatar avatar-30 no-padding rounded-circle counter-decrease"
                                                          data-pid="${item.id}" 
                                                          data-type="${type}"
                                                          >
                                                              <i class="icons f7-icons">minus</i>
                                                          </button>

                                                          ${item.isCartQnt > 0 && $h`
                                                            <span class="counter-value font-13">${item.isCartQnt}</span>
                                                          `}
                                                          ${item.isCartQnt == 0 && $h`
                                                            <span class="counter-value font-13">1</span>
                                                          `}
                                                         


                                                          <button class="btn avatar avatar-30 no-padding rounded-circle  counter-increase"
                                                          data-pid="${item.id}" 
                                                          data-type="${type}"
                                                          
                                                          >
                                                              <i class="icons f7-icons">plus</i>
                                                          </button>
                                                        </div>


                                                    </div>    
                                              </div>   
                                          </div>
                                         
                                      </div>
                                  </a>
                              </li>
                            `)}  

                          </ul>
                      </div>
                  </div>
              </div>
          </div>
         </div>

      

        ${type == "category" && $h`
        <div class="block">
          <div class="row padding-right">

            ${product.map((item) => $h`

            <div class="col-50 medium-33 large-25 padding-left-half no-padding-right">
              <div class="card elevation-2 product margin-bottom">
                <div class="card-content card-content-padding-mini">
                  <div class="row">
                    <!-- <div class="text-align-center avatar ptoduct-image rounded thum-parent">
                      <img src="${item.img}" class="thum-child" alt="" />
                    </div> -->
                    <figure class="text-align-center">
                      <img src="${item.img}" alt="" />
                    </figure>

                  </div>
                 
                  <!-- <p class="">
                    <small class="text-opac">Fresh</small>
                    <small class="float-right"><span class="text-opac">4.5</span> <i
                        class="icons f7-icons text-color-yellow">star</i></small>
                  </p> -->
                  ${type == "category" && $h`
                  <a href="/product/${item.id}/" class="text-normal margin-top-half display-block">
                    <div class="text-color-theme font-12">${item.name}</div>
                  </a>
                  `}

                  ${type == "labtest" && $h`
                  <a class="text-normal margin-bottom-half display-block">
                    <h6 class="text-color-theme">${item.name}</h6>
                  </a>
                  `}

                  <div class="row">
                    <div class="col">
                      <p class="no-margin-bottom">
                        <small class="font-12">MRP</small> : <small class="text-opac" style="text-decoration: line-through;">₹
                          ${item.MRP}</small><br />
                          <span class="font-12">₹ ${item.discount}</span>
                        
                      </p>
                    </div>
                    <div class="col-auto no-padding-left ">
                      <button
                        class="button avatar avatar-40 no-padding rounded-circle elevation-3 button-gradient  add-to-card-button"
                        data-pid="${item.id}" data-mrp="${item.MRP}" data-price="${item.discount}"
                        data-name="${item.name}" data-image="${item.img}" data-type="${type}">
                        <i class="icons f7-icons">plus</i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            `)}

          </div>
        </div>
        `}

      

        <!-- add product popup-->
        <div class="popup addproduct">
          <div class="view">
            <div class="page">
              <div class="navbar">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="left">
                    <a class="link popup-close"><i class="icons f7-icons">arrow_left</i></a>
                  </div>
                  <div class="title">Add to Cart</div>
                  <div class="right">
                    <!-- Link to close popup -->
                    <a class="link popup-close"><i class="icons f7-icons">multiply</i></a>
                  </div>
                </div>
              </div>
              <div class="page-content">
                <div class="block margin-bottom">
                  <figure class="text-center padding">
                    <img src="${productDetails.image}" alt="" class="mw-100" />
                  </figure>
                </div>
                <div class="block margin-bottom">
                  <!-- <p class="margin-bottom-half">
                    <small class="text-opac">Fresh</small>
                    <small class="float-end"><span class="text-opac">4.5</span> <i
                        class="bi bi-star-fill text-warning"></i></small>
                  </p> -->
                  <a href="product.html" class="text-normal display-block margin-bottom-half">
                    <h6 class="text-color-theme">${productDetails.name}</h6>
                  </a>
                  <div class="row">
                    <div class="col">
                      <p class="no-margin-bottom">
                        <small>MRP</small> : <small class="text-opac" style="text-decoration: line-through;">₹
                          ${productDetails.mrp}</small><br />
                        ₹ ${productDetails.price}
                      </p>
                    </div>
                    <div class="col-auto">
                      <!-- Stepper element -->
                      <div class="stepper">
                        <div class="stepper-button-minus counter-decrease"></div>
                        <!-- Stepper value element -->
                        <div class="stepper-value counter-value">1</div>
                        <div class="stepper-button-plus counter-increase"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="block">
                  <button @click="${app.params.addToCartCurrentProduct}" type="button"
                    class="button button-large button-fill color-green elevation-3 adding-cart"
                    data-pid="${productDetails.pid}">Add to Cart
                    <i class="icons f7-icons">arrow_right</i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>
      <!-- main page content ends -->

    </div>

     <!-- footer static -->
     <footer class="footer">
      <div class="container">
          <ul>
              <li>
                  <a class="active" href="/home/">
                      <span>
                          <i class="icon f7-icons">house</i>
                          <span class="nav-text">Home</span>
                      </span>
                  </a>
              </li>
              <li>
                  <a  href="/nearByLabList/">
                      <span>
                          <i class="icon f7-icons">eyedropper_halffull</i>
                          <span class="nav-text">Lab</span>
                      </span>
                  </a>
              </li>
              <li class="center-item">
                  <a href="/cart/">
                      <span>
                          <i class="icon f7-icons">cart</i>
                          <span class="nav-text">card-content</span>
                          <span class="countercart">${cartCount}</span>
                      </span>
                  </a>
              </li>
              <li>
                  <a href="/profile/">
                      <span>
                          <i class="icon f7-icons">person</i>
                          <span class="nav-text">Profile</span>
                      </span>
                  </a>
              </li>
              <li>
                  <a href="/contactus/">
                      <span>
                          <i class="icon f7-icons">question_circle</i>
                          <span class="nav-text">Help</span>
                      </span>
                  </a>
              </li>
          </ul>
      </div>
  </footer>



  </div>
</template>
<script>
  export default (props, {
    $f7,
    $theme,
    $on,
    $update,
    $
  }) => {
    var app = $f7;
    let product = [];
    let categoryName = "";
    let type = props.type;
    let value = props.value;
    let productDetails = {
      price: "",
      image: "",
      mrp: "",
      name: "",
      pid: "",
      type: ""
    };
    const pageId = app.params.uuid();
    let cartCount = 0;

    //  console.log('countdata',cartCount);

    // const openProductPopup = (e)=>{
    //   // console.log(e);
    //   // var $ = this.$;

    //   // productDetails = $(this).attr('data-pid');
    //   productDetails = e.target.dataset();
    //   console.log("product details",productDetails);

    // }

    $(document).on('click', '#pageId_' + pageId + ' .product_add_to_cart', function (e) {

      productDetails = $(this).dataset();
      $f7.preloader.show();
      
      //show counter and hide the add button 
      $(this).addClass("display-none");
      $(this).parent().find(".counter-number").removeClass("display-none");

      const addingCartOnLive = app.params.callToServer("add-cart-single", productDetails,
      function success(Responce) {
        $f7.preloader.hide();

        let toastBottom = app.toast.create({
          text: "Product has been added successfully !! ",
          closeTimeout: 2000,
          });
          toastBottom.open();

          cartCount = Responce.data.cartCount;
          $update();
      });

    })

    $(document).on('click',  '#pageId_' + pageId +' .counter-increase', function (e) {
      var countValue = parseInt($(this).parent().find(".counter-value").text());
      countValue = countValue + 1;
      $(this).parent().find(".counter-value").text(countValue);
      app.params.currentProductDetails.quantity = countValue;

      //update on cart
      productDetails = $(this).dataset();
      productDetails.quantity = countValue;
      app.preloader.show();
      app.params.callToServer("update-cart", productDetails,
      function success(Responce) {
        app.preloader.hide();
      });
    });

    $(document).on('click',  '#pageId_' + pageId +' .counter-decrease', function (e) {
      var countValue = parseInt($(this).parent().find(".counter-value").text());
      countValue = countValue - 1;

       //update on cart
      productDetails = $(this).dataset();
      productDetails.quantity = countValue;
      app.preloader.show();
      app.params.callToServer("update-cart", productDetails,
      function success(Responce) {
        app.preloader.hide();
      });

      if (countValue > 0) {
        $(this).parent().find(".counter-value").text(countValue);
        app.params.currentProductDetails.quantity = countValue;
      }else{ // show add button and hide counter 
          //show counter and hide the add button 
        $(this).parent().addClass("display-none");
        $(this).parent().parent().find(".product_add_to_cart").removeClass("display-none");

      }
    
    });





    $(document).on('click', '.adding-cart_', function (e) {
      //console.log('adding clicked');
      //let pid = $(this).data('pid'); 
      let countValue = parseInt($(this).parent().parent().find(".counter-value").text());

      var currentProduct = {
        price: productDetails.discount,
        image: productDetails.imageurl,
        mrp: productDetails.mrp,
        name: productDetails.name,
        pid: productDetails.pid,
        quantity: countValue
      }

      // console.log(currentProduct);

      //======= cart value from server =======
      const addingCartOnLive = app.params.callToServer("add-cart", currentProduct,
        function success(Responce) {
          $f7.preloader.hide();
          cartCount = Responce.data.cartCount;
          localStorage.setItem("cartCount", cartCount);
          // categoryName = Responce.data.category;
          $update();
        });
      //========
      //====== get card value from store ===
      // JSON.parse(localStorage.getItem('myItem'))

      //  let cart =  JSON.parse(localStorage.getItem("cart"));
      //  console.log("cart strored",cart);

      //   if(cart == null){
      //    let cartList = [currentProduct];
      //      //====== adding cart store ============
      //     localStorage.setItem("cart",JSON.stringify(cartList));
      //   }else{ //====== add new item on cart ========
      //     cart.push(currentProduct);
      //      //====== update cart store ============
      //      localStorage.setItem("cart",JSON.stringify(cart));
      //   }



      // console.log(JSON.parse(localStorage.getItem("cart")));
      // console.log(localStorage.getItem("cart"));
      // $update();
      app.popup.close('.addproduct');
    })

    $on('pageInit', () => {

      $f7.preloader.show();

      app.params.callToServer("product-list", '{"type":"' + type + '","value":' + value + '}', success);

      function success(Responce) {
        $f7.preloader.hide();
        product = Responce.data.product;
        categoryName = Responce.data.category;
        $update();
      }

       //cart count updation 
       app.params.callToServer('cart-count','', function (response) {
        if (response.success) {
            cartCount =  response.data.cartCount;
        }
        $update();
      });





    });

    $on('pageBeforeRemove', () => {

    })

    return $render;
  }
</script>