<template>
  <div class="page page-OrderByPrescription" id="pageId_${pageId}" data-name="OrderByPrescription">
    <div class="navbar ">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="left  no-margin-right">
          <a href="#" class="link icon-only back">
            <i class="icon f7-icons size-22">arrow_left</i>
          </a>
        </div>
        <div class="title">
          <h5 class="no-margin-bottom">Order by prescrtiption</h5>
        </div>
        <div class="right">
          <a href="/notificationlist/" class="link">
            <i class="icon f7-icons size-22">bell_fill</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content has-footer">
      <!-- main page content -->
      <div class="main-container container margin-bottom-half">
        <form id="prescript-submit-form">

          <!-- icons here -->
          <div class="block">
            <div class="row margin-bottom-half text-align-center">
              <div class="col" @click="${() => openCamera()}">
                <i class="icon f7-icons size-50">camera</i>
                <p>Camera</p>
              </div>

              <div class="col" @click="${() => openSaveImage()}">
                <i class="icon f7-icons size-50">arrow_down_to_line_alt</i>
                <p>Saved</p>
              </div>

              <div class="col" @click="${() => openGallery()}">
                <i class="icon f7-icons size-50">photo_fill_on_rectangle_fill</i>
                <p>gallery</p>
              </div>
            </div>
          </div>

          <div class="block" >
            <div class="row margin-bottom-half_ margin-left  padding-left" id="selected_prescription_container">
              
            </div>
          </div>

          <!-- Notes messages -->
          <div class="block">
            <div class="row margin-bottom-half">
              <div class="col">
                <h5 class="no-margin-bottom"><p>Helpful actions</p></h5>
              </div>
            </div>
            <div class="row margin-bottom-half">
              <div class="col">
                <div class="card elevation-2">
                  <div class="list ">
                    <ul class="">

                      <li class="item-content">
                        <div class="item-inner item-cell ">
                          <div class="row">
                            <div class="col-auto"><i class="icon f7-icons">checkmark_alt_circle</i></div>
                            <div class="col no-padding-left">Only upload .jpg/.jpeg/.png/.pdf files</div>
                            <div class="col-auto align-self-center">
                              <!-- <i class="icon f7-icons size-18 text-muted">chevron_right</i> -->
                            </div>
                          </div>
                        </div>
                      </li>

                      <li class="item-content">
                        <div class="item-inner item-cell ">
                          <div class="row">
                            <div class="col-auto"><i class="icon f7-icons">checkmark_alt_circle</i></div>
                            <div class="col no-padding-left">You can upload maxmimum 4 images</div>
                            <div class="col-auto align-self-center">
                              <!-- <i class="icon f7-icons size-18 text-muted">chevron_right</i> -->
                            </div>
                          </div>
                        </div>
                      </li>

                      <li class="item-content">
                        <div class="item-inner item-cell ">
                          <div class="row">
                            <div class="col-auto"><i class="icon f7-icons">checkmark_alt_circle</i></div>
                            <div class="col no-padding-left">You can upload maxmimum 1 pdf</div>
                            <div class="col-auto align-self-center">
                              <!-- <i class="icon f7-icons size-18 text-muted">chevron_right</i> -->
                            </div>
                          </div>
                        </div>
                      </li>

                      <li class="item-content">
                        <div class="item-inner item-cell ">
                          <div class="row">
                            <div class="col-auto"><i class="icon f7-icons">checkmark_alt_circle</i></div>
                            <div class="col no-padding-left">You can upload maxmimum file size 5 mb</div>
                            <div class="col-auto align-self-center">
                              <!-- <i class="icon f7-icons size-18 text-muted">chevron_right</i> -->
                            </div>
                          </div>
                        </div>
                      </li>

                      <li class="item-content">
                        <div class="item-inner item-cell ">
                          <div class="row">
                            <div class="col-auto"><i class="icon f7-icons">checkmark_alt_circle</i></div>
                            <div class="col no-padding-left">Image and pdf can't be upload simultaneously</div>
                            <div class="col-auto align-self-center">
                              <!-- <i class="icon f7-icons size-18 text-muted">chevron_right</i> -->
                            </div>
                          </div>
                        </div>
                      </li>
                      <li class="item-content">
                        <div class="item-inner item-cell ">
                          <div class="row">
                            <div class="col-auto">
                              <i class="icon f7-icons">checkmark_alt_circle</i>
                            </div>
                            <div class="col no-padding-left">Prescription uploaded is subject to verification</div>
                            <div class="col-auto align-self-center">
                              <!-- <i class="icon f7-icons size-18 text-muted">chevron_right</i> -->
                            </div>
                          </div>
                        </div>
                      </li>

                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- oreder note  -->
          <div class="block ">
            <div class="row margin-bottom-half">
              <div class="col">
                <h5 class="no-margin-bottom"><p>Order Note</p></h5>
              </div>
            </div>
            <div class="row margin-bottom-half">
              <div class="col">

                <div class="card elevation-2">
                  <div class="list md ">
                    <ul>
                      <li>
                        <label class="item-radio item-radio-icon-start item-content">
                          <input type="radio" name="orderNote" value="all" checked />
                          <i class="icon icon-radio text-color-theme"></i>
                          <div class="item-inner">
                            <div class="">All Medicines (in prescription)</div>
                          </div>
                        </label>
                      </li>
                      <li>
                        <label class="item-radio item-radio-icon-start item-content">
                          <input type="radio" name="orderNote" value="selected" />
                          <i class="icon icon-radio text-color-theme"></i>
                          <div class="item-inner">
                            <div class="">Order by sequence of medicine (as they appear in prescription)
                            </div>
                          </div>
                        </label>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <input type="hidden" value="" id="selectedMedicineSerial" name="no_of_medicine" />
            <input type="hidden" value="" id="prescriptionIdList" name="prescription_id" />

          </div>

          <!-- categories -->
          <div class="block" id="medicineSelectButton" style="display: none;">
            <div class="row margin-bottom-half">
              <div class="col">
                <!-- <div class="block"> -->
                <div class="swiper-container categoriesswiper ">
                  <!-- Additional required wrapper -->
                  <div class="swiper-wrapper ">
                    <!-- Slides -->

                    <div class="swiper-slide slider1">
                      <div class="card elevation-2 ">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">1</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">2</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">3</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">4</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">5</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">6</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">7</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">8</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">9</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">10</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">11</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">12</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">13</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">14</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">15</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">16</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">17</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">18</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">19</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>

                    <div class="swiper-slide">
                      <div class="card elevation-2">
                        <div class="card-content card-content-padding">
                          <p class="categoryname">20</p>
                        </div>
                      </div>
                      <!-- <p class="categoryname">Baby Food</p> -->
                    </div>






                  </div>
                </div>
                <!-- </div> -->
              </div>
            </div>
          </div>

          <!-- warning section--
          <div class="block">
          <div class="row margin-bottom-half">
              <div class="col">
                      <p class="row">
                        <button class="col slider2 button-large button-raised"> warning</button>
                      </p>
              </div>
          </div>
          </div> -->

          <!-- term acceptance  -->
          <div class="block ">
            <div class="row margin-bottom-half margin-top-half">
              <div class="col">
                <div class="card elevation-2 ">
                  <div class="card-content card-content-padding">
                    <p>
                      <label class="checkbox margin-right-half">
                        <input type="checkbox" name="termChecked" id="termCHeckId" value="termYes" />
                        <i class="icon-checkbox"></i>
                      </label>
                      I agree to the <a class="external" href="https://capsuleplus.in/page/term-condition" target="_blank">terms & conditions</a> and <a class="external" href="https://capsuleplus.in/page/privacy-policy" target="_blank">privacy policy</a>
                    </p>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="block">
            <div class="row margin-bottom">
              <div class="col-100 medium-50 large-33 margin-h-auto">
                <input type="submit" class="button button-fill button-large button-raised" name="Save" />
              </div>
            </div>
          </div>


        </form>



         <!-- add product popup-->
         <div class="popup saveImageList">
          <div class="view">
            <div class="page">
              <div class="navbar">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="left">
                    <a class="link popup-close"><i class="icons f7-icons">arrow_left</i></a>
                  </div>
                  <div class="title">Save Prescription</div>
                  <div class="right">
                    <!-- Link to close popup -->
                    <a class="link popup-close"><i class="icons f7-icons">multiply</i></a>
                  </div>
                </div>
              </div>
              <div class="page-content">

                <div class="block" >

                ${savePrescription.map((item) => $h`

                  <div class="row">
                    <div class="col-100 medium-50 large-33">
                      <div class="card elevation-2 margin-bottom-half">
                          <div class="card-content card-content-padding">
                              <div class="row">
                                  <div class="col-100">
                                      <figure class="text-align-center margin-bottom-half  page-bg rounded h-150">
                                          <img src="${item.thumbnail}" alt=""  />
                                      </figure>
                                  </div>
                                  <div class="col">
                                      <p class="small display-block">
                                          <span class="float-end">
                                            <span class="text-opac">${item.created_at}</span> 
                                            <i class="bi bi-clock"></i>
                                          </span>
                                      </p>
                                      <button class="button button-fill button-small button-raised"
                                      @click="${() => selectPrescription(item.thumbnail,item.id)}"
                                      >
                                          Select Prescription
                                      </button>
                                      <!-- <input type="button" data-id="${item.id}" data-thumbnail="{item.thumbnail}" class="selectPrescriptionCheck" value="Select Prescription" />
                                      <label class="checkbox margin-right-half">
                                       
                                        <i class="icon-checkbox"></i>
                                      </label> -->
                                       
                                  </div>
                              </div>
                          </div>
                      </div>
                    </div>
                  </div> 

                `)}    
                  
                </div>

                
               

              </div>
            </div>
          </div>
        </div>

      </div>
      <!-- main page content ends -->

    </div>

    <!-- footer static -->
    <footer class="footer">
      <div class="container">
          <ul>
              <li>
                  <a class="active" href="/home/">
                      <span>
                          <i class="icon f7-icons">house</i>
                          <span class="nav-text">Home</span>
                      </span>
                  </a>
              </li>
              <li>
                  <a  href="/nearByLabList/">
                      <span>
                          <i class="icon f7-icons">eyedropper_halffull</i>
                          <span class="nav-text">Lab</span>
                      </span>
                  </a>
              </li>
              <li class="center-item">
                  <a href="/cart/">
                      <span>
                          <i class="icon f7-icons">cart</i>
                          <span class="nav-text">card-content</span>
                          <span class="countercart">${cartCount}</span>
                      </span>
                  </a>
              </li>
              <li>
                  <a href="/profile/">
                      <span>
                          <i class="icon f7-icons">person</i>
                          <span class="nav-text">Profile</span>
                      </span>
                  </a>
              </li>
              <li>
                  <a href="/contactus/">
                      <span>
                          <i class="icon f7-icons">question_circle</i>
                          <span class="nav-text">Help</span>
                      </span>
                  </a>
              </li>
          </ul>
      </div>
  </footer>

  </div>
</template>
<script>
  export default (props, {
    $f7,
    $theme,
    $on,
    $update,
    $
  }) => {

    var app = $f7;
    const pageId = app.params.uuid();
    let numberList = [];
    let prescriptionList = [];
    let savePrescription = [];
    let cartCount = 0;
    //file upload 
    const openCamera = () => {

      var options = {
        // Some common settings are 20, 50, and 100
        quality: 75,
        destinationType: Camera.DestinationType.FILE_URI,
        // In this app, dynamically set the picture source, Camera or photo gallery
        sourceType: Camera.PictureSourceType.CAMERA,
        encodingType: Camera.EncodingType.JPEG,
        mediaType: Camera.MediaType.PICTURE,
        allowEdit: false,
        correctOrientation: true
      }

      navigator.camera.getPicture(function (imageURI) {
          console.log(imageURI);
          fileUpload(imageURI);

        }, function (message) {
          console.log('Failed because: ' + message);
        },
        options
      );
    }

    // const openGallery = () 

    const openGallery = () => {

      var options = {
        // Some common settings are 20, 50, and 100
        quality: 75,
        destinationType: Camera.DestinationType.FILE_URI,
        // In this app, dynamically set the picture source, Camera or photo gallery
        sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
        encodingType: Camera.EncodingType.JPEG,
        mediaType: Camera.MediaType.PICTURE,
        allowEdit: false,
        correctOrientation: true
      }

      navigator.camera.getPicture(function (imageURI) {
          console.log(imageURI);
          fileUpload(imageURI);

        }, function (message) {
          console.log('Failed because: ' + message);
        },
        options
      );
    }

    const openSaveImage = () => {

      app.preloader.show();
      $('#selected_prescription_container_popup').html("");
      app.params.callToServer("save-prescription-list", "",
                  function success(Responce) {
                      $f7.preloader.hide();
                      //if successfully submited 
                      if(Responce.success){

                        savePrescription = Responce.data
                        $update();
                        app.popup.open(".saveImageList");
                      }
                  
                  });
      
    }

    const fileUpload = (imageURI) => {
      var progressValue = 0;
       //open progessbar ==   
       var dialog = $f7.dialog.progress('Uploading ... ', progressValue);
           dialog.setText(progressValue+'%');

      var options = new FileUploadOptions();
      options.fileKey = "image";
      options.fileName = imageURI.substr(imageURI.lastIndexOf('/') + 1);
      options.mimeType = "image/jpeg";
      options.headers = {
        Connection: "close"
      }
      options.chunkedMode = false;

      var params = {};
      //params.ipdid = ipdid;
      // params.oxyLabel = oxyLabel;
      options.params = params;
      var headers = {
        'Authorization': 'Bearer ' + localStorage.getItem("token"),
        'Accept': 'application/json'
      };
      options.headers = headers;

      var ft = new FileTransfer();
      //need to add header with user details 
      var url = app.params.remoteUrl + 'upload-prescription/';
      
     // handle progress bar 
      ft.onprogress = function (progressEvent) {

        if (progressEvent.lengthComputable) {
          // Calculate the percentage
         // console.log(progressEvent);
          progressValue = parseInt((progressEvent.loaded / progressEvent.total)*100);
        } else {
          progressValue++;
        }

        // Display percentage in the UI
        dialog.setProgress(progressValue);
        dialog.setText(progressValue+'%');
        console.log(progressValue);
        
      };

      //handle file upload 
      ft.upload(imageURI, url,
        function (result) {
          dialog.close();
          
          var data = JSON.parse(result.response);
          console.log(data);

          var imageURL = data.data.image;
          var prescritionID = data.data.id;
          var thumpURL = data.data.thumbnail;

          //apend image on prescription area 
          selectImage(prescritionID,thumpURL);
          calculateSelectedPrescrip_id();

        },
        function (error) {
          dialog.close();
          var data = JSON.parse(error.body);

          let toastBottom = app.toast.create({
            text: "data.",
            closeTimeout: 2000,
            });
            toastBottom.open();
          console.log(error);
          
        }, options);

    }
    
    const selectPrescription =(imageURI,imageId) =>{
        //apend image on prescription area 
        selectImage(imageId,imageURI);
        calculateSelectedPrescrip_id();
        app.popup.close(".saveImageList");

    }



    //show uploaded image 
    const selectImage = (imageId,imageUrl)=>{
     
      var selectedImage = '<div class="margin-half ">'+
        '                <div class="card-content ">'+
        '                  <div style="display:none" class="prescripId" >'+imageId+'</div>'+
        '                  <img slot="media" src="'+imageUrl+'" width="75" alt=""/>'+
        '                </div>'+
        '              </div>';

      $('#selected_prescription_container').append(selectedImage);  
    }

    const openSuccessPopUp = (result) => {

      patientData = JSON.parse(result);

      app.popup.open('#my-popup', true);
      $('#my-popup').on('popup:opened', function (e) {
        console.log('About popup open');
        if (patientData.status) {
          app.statusbar.setBackgroundColor('#4caf50');
          app.statusbar.setTextColor('white');
          $update();
        } else {
          app.statusbar.setBackgroundColor('#f44336');
          app.statusbar.setTextColor('white');
          $update();
        }
      });


    }

    const closePopUp = () => {
      console.log("close hua ");
      pageRefreh();
      app.statusbar.setBackgroundColor('#ffffff');
      app.statusbar.setTextColor('black');
      app.popup.close('#my-popup', true);
    }


    //end file upload 

    //calculate selected list
    const calculateSelectedNumber = () => {
      numberList = [];
      $('#selectedMedicineSerial').val("")

      let selectedButton = '#pageId_' + pageId + ' #medicineSelectButton  .selected-medicine-number';
      $(selectedButton).each(function (e) {
        let nbr = $(this).find('.categoryname').text();
        numberList.push(nbr);
      });

      $('#selectedMedicineSerial').val(JSON.stringify(numberList))

    }
    

    const calculateSelectedPrescrip_id = () => {
      prescriptionList = [];
      $('#prescriptionIdList').val("")

      let selectedButton = '#pageId_' + pageId + ' #selected_prescription_container .prescripId';
      $(selectedButton).each(function (e) {
        let nbr = $(this).text();
        prescriptionList.push(nbr);
      });
      console.log(prescriptionList);
      $('#prescriptionIdList').val(JSON.stringify(prescriptionList))

    }




    // === display medicine selection button list ===
    $(document).on('change', "#pageId_" + pageId + " input[name='orderNote']", function (e) {
      let checkeedVal = $(this).val();
      if (checkeedVal == 'selected') {
        $('#medicineSelectButton').show();
      } else {
        $('#medicineSelectButton').hide();
      }

    });


    //medicine selection 
    $(document).on('click', '#pageId_' + pageId + ' #medicineSelectButton  .swiper-slide .card', function (e) {

      if ($(this).hasClass('selected-medicine-number')) {
        $(this).removeClass('selected-medicine-number');
      } else { //seleceted 
        $(this).addClass('selected-medicine-number');
      }
      //update selected button 
      calculateSelectedNumber();

    });

    //submit final prescription form
    $(document).on('submit', '#pageId_' + pageId + ' #prescript-submit-form', function (e) {
      e.preventDefault();

      let formData = app.form.convertToData('#pageId_' + pageId + ' #prescript-submit-form');
      let isChecked = e.target["termCHeckId"].checked;
      if (isChecked) { // form is ready 
        //TODO : need to add file upload functionality
        
        if (prescriptionList.length !== 0) {
              console.log(formData);
              $f7.preloader.show();
              //=======remove cart items from server =======
              app.params.callToServer("order-by-prescription", formData,
                  function success(Responce) {
                      $f7.preloader.hide();
                      //if successfully submited 
                      if(Responce.success){
                          app.views.main.router.navigate('/thankyouorder/', {
                            ignoreCache: true,
                            reloadCurrent: true,
                          });
                          app.views.main.router.clearPreviousHistory();
                      }
                  
                  });
          } else {
            let toastBottom = app.toast.create({
              text: "Please upload prescrition before submit !!",
              closeTimeout: 2000,
            });
            toastBottom.open();
          } 
            
      } else {
        let toastBottom = app.toast.create({
          text: "Please checked the term before submit !!",
          closeTimeout: 2000,
        });
        toastBottom.open();
      }



    });


    $on('pageBeforeOut', () => {

    })

    $on('pageBeforeRemove', () => {
      // Destroy toasts when page removed
    })


    $on('pageInit', () => {
      /* carousel */
      var swiper1 = new Swiper(".categoriesswiper", {
        slidesPerView: "auto",
        spaceBetween: 12,
      });

       //cart count updation 
       app.params.callToServer('cart-count','', function (response) {
        if (response.success) {
            cartCount =  response.data.cartCount;
        }
        $update();
      }); 



    })

    return $render;
  }
</script>